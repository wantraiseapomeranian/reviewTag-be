<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace = "contents">
 	
 	<insert id="upsertContent" parameterType="com.kh.finalproject.vo.contents.ContentsVO">
 		MERGE INTO contents C
 		using dual
 		on (C.contents_id = #{contentsId})
 		WHEN MATCHED THEN
 			UPDATE SET
 				C.contents_title = #{contentsTitle},
 				C.contents_type = #{contentsType},
 				C.contents_overview = #{contentsOverview},
 				C.contents_poster_path = #{contentsPosterPath},
 				C.contents_backdrop_path = #{contentsBackdropPath},
 				C.contents_vote_average = #{contentsVoteAverage},
 				C.contents_runtime = #{contentsRuntime},
 				C.contents_release_date = TO_DATE(#{contentsReleaseDate}, 'YYYY-MM-DD'),
                C.contents_director = #{contentsDirector},           
                C.contents_main_cast = #{contentsMainCast}           
 		WHEN NOT MATCHED THEN
 			INSERT (
 				contents_id, contents_title, contents_type, 
 				contents_overview, contents_poster_path, 
 				contents_backdrop_path, contents_vote_average,
 				contents_runtime,
 				contents_release_date, contents_language,
                contents_director,                              
                contents_main_cast                              
 			)
 			VALUES (
 				#{contentsId}, #{contentsTitle}, #{contentsType},
 				#{contentsOverview}, #{contentsPosterPath},
 				#{contentsBackdropPath}, #{contentsVoteAverage},
 				#{contentsRuntime},
 				TO_DATE(#{contentsReleaseDate}, 'YYYY-MM-DD'), 'ko',
                #{contentsDirector},                            
                #{contentsMainCast}                             
 			)
 	</insert>
 	
 	<insert id="upsertGenreMap" parameterType="com.kh.finalproject.vo.contents.ContentsGenreMapVO">
 		MERGE INTO contents_genre_map CGM
 		USING DUAL
 		ON (CGM.contents_id = #{contentsId} AND CGM.genre_id = #{genreId})
 		WHEN NOT MATCHED THEN
 			INSERT (contents_id, genre_id)
 			VALUES (#{contentsId}, #{genreId})
 	</insert>
 	
 	<delete id="deleteGenreMapping" parameterType="long">
 		DELETE FROM contents_genre_map WHERE contents_id = #{contentsId}
 	</delete>
 	
 	<insert id="upsertGenre" parameterType="com.kh.finalproject.dto.contents.ContentsGenreDto">
        MERGE INTO contents_genre CG
        USING DUAL
        ON (CG.genre_id = #{genreId})
        WHEN MATCHED THEN
            UPDATE SET 
                CG.genre_name = #{genreName}
        WHEN NOT MATCHED THEN
            INSERT (genre_id, genre_name)
            VALUES (#{genreId}, #{genreName})
    </insert>
    
   <resultMap id="contentDetailMap" type="com.kh.finalproject.dto.contents.ContentsDetailDto">
        <id property="contentsId" column="contents_id"/>
        <result property="contentsTitle" column="contents_title"/>
        <result property="contentsType" column="contents_type"/>
        <result property="contentsOverview" column="contents_overview"/>
        <result property="contentsPosterPath" column="contents_poster_path"/>
        <result property="contentsBackdropPath" column="contents_backdrop_path"/>
        <result property="contentsVoteAverage" column="contents_vote_average"/>
        <result property="contentsRuntime" column="contents_runtime"/>
        <result property="contentsReleaseDate" column="contents_release_date"/>
        
        <result property="contentsDirector" column="contents_director"/>       <!-- ★ 추가: 감독 매핑 ★ -->
        <result property="contentsMainCast" column="contents_main_cast"/>     <!-- ★ 추가: 주연 배우 매핑 ★ -->
        
        <!-- 장르 이름을 List<String> 타입의 genreNames 필드에 모아서 매핑합니다. -->
        <collection property="genreNames" ofType="string">
            <result column="genre_name_alias"/>
        </collection>
    </resultMap>
    
    <select id="selectContentDetailWithGenres" resultMap="contentDetailMap" parameterType="long">
        SELECT
            C.*,
            CG.genre_name AS genre_name_alias
        FROM
            contents C
        LEFT JOIN
            contents_genre_map CGM ON C.contents_id = CGM.contents_id
        LEFT JOIN
            contents_genre CG ON CGM.genre_id = CG.genre_id
        WHERE
            C.contents_id = #{contentsId}
    </select>
    
    <select id="selectContentsByGenre" resultMap="contentDetailMap" parameterType="map">
      SELECT 
            MAIN.*, 
            CG.genre_name AS genre_name_alias
        FROM (
            SELECT * FROM (
                SELECT T.*, ROWNUM AS rn FROM (
                    SELECT C.*
                    FROM contents C
                    WHERE C.contents_id IN (
                        SELECT 
                            sub_map.contents_id
                        FROM 
                            contents_genre_map sub_map
                        JOIN 
                            contents_genre sub_genre ON sub_map.genre_id = sub_genre.genre_id
                        WHERE
                           <choose>
                               <when test="genreId != null">
                                   sub_genre.genre_id = #{genreId}
                               </when>
                               <when test="genreName != null">
                                   sub_genre.genre_name = #{genreName}
                               </when>
                           </choose>
                    )
                    ORDER BY C.contents_release_date DESC
                ) T
                WHERE ROWNUM &lt;= #{end}
            )
            WHERE rn &gt;= #{start}
        ) MAIN
        
        LEFT JOIN contents_genre_map CGM ON MAIN.contents_id = CGM.contents_id
        LEFT JOIN contents_genre CG ON CGM.genre_id = CG.genre_id
        
        ORDER BY MAIN.contents_release_date DESC
    </select>
    
    <select id="selectContentsList" resultMap="contentDetailMap" parameterType="map">
        SELECT 
            MAIN.*, 
            CG.genre_name AS genre_name_alias
        FROM (
            SELECT * FROM (
                SELECT T.*, ROWNUM AS rn FROM (
                    SELECT C.*
                    FROM contents C
                    ORDER BY C.contents_release_date DESC
                ) T
                WHERE ROWNUM &lt;= #{end}
            )
            WHERE rn &gt;= #{start}
        ) MAIN
        
        LEFT JOIN contents_genre_map CGM ON MAIN.contents_id = CGM.contents_id
        LEFT JOIN contents_genre CG ON CGM.genre_id = CG.genre_id
        
        ORDER BY MAIN.contents_release_date DESC
    </select>
    
     <select id="selectContentsListByType" resultMap="contentDetailMap" parameterType="map">
       SELECT 
            C.*, 
            CG.genre_name AS genre_name_alias
        FROM 
            contents C
        LEFT JOIN contents_genre_map CGM ON C.contents_id = CGM.contents_id
        LEFT JOIN contents_genre CG ON CGM.genre_id = CG.genre_id
        WHERE 
            C.contents_type = #{type}
        ORDER BY 
            C.contents_release_date DESC
    </select>
    
    <select id="selectGenreList" resultType="GenreDto">
    	SELECT * FROM contents_genre
    </select>
    
    <select id="detailGenre" resultType="GenreDto">
    	SELECT * FROM contents_genre WHERE genre_id=#{genreId}
    </select>
 	
 </mapper>